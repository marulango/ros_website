<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>rOpenSci | Tutorial Title</title><!-- IMPORTANT: This should display the post title! -->
    <link rel="stylesheet" type="text/css" href="css/style.css" /> <!-- stylesheet imports -->
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- this one is super important for mobile devices -->
</head>
<body>
<!-- begins full header -->
    <div id="header">
        <div class="container">
            <div class="row">
                <!-- ropensci logo container -->
                <div class="col-1">
                    <a href="/index.html"><img src="img/icon_lettering_white.svg" /></a>
                </div>
                <!-- ends ropensci logo container -->
                <!-- begins navigation list in main menu -->
                <nav class="col-6 col-offset-4 top-3">
                    <ul class="row between">
                        <li><a href="blog.html">Blog</a></li>
                        <li><a href="packages.html">Packages</a></li>
                        <li><a href="community.html">Community</a></li>
                        <li><a href="http://discuss.ropensci.org/" target="_blank">Discuss</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </nav>
                <!-- ends navigation list in main menu -->
            </div><!-- /row -->
        </div><!-- /container -->
    </div>
<!-- ends full Header -->

<!-- begins post section -->
    <article>
        <div class="container top-20">
            <div class="row centered">
                <div class="col-2 sidebar top-5">
                        <ul class="autoSidebar">
                            <!-- sidebar items are self generated by post titles and subtitles, just make sure that you're using H3 and H4s -->
                        </ul>
                </div> <!-- /navigation sidebar -->

                <div class="col-7 bottom-20 maintext">
                    <small class="meta">Jun 12, 2015</small>
                    <h2>Treebase tutorial</h2>
                    <small class="version">for v0.0-7.1</small><!-- ************************************* TODO: add report bug and licence type -->

                    <p>Here are a few introductory examples to illustrate some of the functionality of the package. Thanks in part to new data deposition requirements at journals such as Evolution, Am Nat, and Sys Bio, and data management plan requirements from NSF, I hope the package will become increasingly useful for teaching by replicating results and for meta-analyses that can be automatically updated as the repository grows. Additional information and bug-reports welcome via the <a href="http://ropensci.org/packages/treebase.html#support">treebase page</a>.</p>

                    <section id="installation">

                        <h3 id="installation">Installation</h3>
                        
                            <pre><code class="r">
install.packages('treebase')
                            </code></pre>

                            <pre class="top-4"><code class="r">
library(treebase)
                            </code></pre>

                    </section><!-- /instalation -->


                    <section id="usage">

                        <h3 id="usage">Usage</h3>
                        <h4 id="basic-tree-and-metadata-queries">Basic tree and metadata queries</h4>

                        <p>Downloading trees by different queries: by author, taxa, &amp; study. More options are described in the help file.</p>
                        <pre><code class="r">
both <- search_treebase("Ronquist or Hulesenbeck", by=c("author", "author"))
dolphins <- search_treebase('"Delphinus"', by="taxon", max_trees=5)
studies <- search_treebase("2377", by="id.study")
                        </code></pre>
                        
                        <pre><code class="r">
Near <- search_treebase("Near", "author", branch_lengths=TRUE, max_trees=3)
Near[1]
                        </code></pre>

                        <pre><code class="r">
[[1]]

Phylogenetic tree with 19 tips and 6 internal nodes.

Tip labels:
    Etheostoma_barrenense_A, Etheostoma_rafinesquei_B, Etheostoma_atripinne_A, Etheostoma_atripinne_D, Etheostoma_atripinne_P, Etheostoma_orientale_H, ...

Unrooted; includes branch lengths.
                        </code></pre>

                        <p>We can query the metadata record directly. For instance, plot the growth of Treebase submissions by publication date</p>
                        
                            <pre><code class="r">
all <- download_metadata("", by="all")
dates <- sapply(all, function(x) as.numeric(x$date))
library(ggplot2)
qplot(dates, main="Treebase growth", xlab="Year", binwidth=.5)
                            </code></pre>
                        
                        <p>(The previous query could also take a date range)</p>

                        <p>How do the weekly's do on submissions to Treebase? We construct this in a way that gives us back the indices of the matches, so we can then grab those trees directly. Run the scripts yourself to see if they've changed!</p>
                        
                            <pre><code class="r">
nature <- sapply(all, function(x) length(grep("Nature", x$publisher))>0)
science <- sapply(all, function(x) length(grep("^Science$", x$publisher))>0)
sum(nature)
sum(science)
                            </code></pre>

                    
                        <h4 id="replicating-results">Replicating results</h4>

                        <p>A nice paper by Derryberry et al. appeared in Evolution recently on <a href="http://www.museum.lsu.edu/brumfield/pubs/furnphylogeny2011.pdf">diversification in ovenbirds and woodcreepers, 0.1111/j.1558-5646.2011.01374.x</a>. The article mentions that the tree is on Treebase, so let's see if we can replicate their diversification rate analysis: Let's grab the trees by that author and make sure we have the right one:</p>
                        
                        
                            <pre><code class="r">
search_treebase("Derryberry", "author")[[1]] -> tree
plot(tree)
                            </code></pre>
                        
                        <p><img src="img/tutorial-images/treebase/unnamed-chunk-3.png" alt="plot of chunk unnamed-chunk-3"> </p>

                        <p>They fit a variety of diversification rate models avialable in the <code class="r">laser</code> R package, which they compare using AIC.</p>

                        
                            <pre><code class="r">
install.packages("laser")
                            </code></pre>

                            <pre><code class="r">
library(laser)
tt <- branching.times(tree)
models <-  list(pb = pureBirth(tt),
                bdfit = bd(tt),
                y2r = yule2rate(tt), # yule model with single shift pt
                ddl = DDL(tt), # linear, diversity-dependent
                ddx = DDX(tt), #exponential diversity-dendent
                sv = fitSPVAR(tt), # vary speciation in time
                ev = fitEXVAR(tt), # vary extinction in time
                bv = fitBOTHVAR(tt)# vary both
                )
names(models[[3]])[5] <- "aic"
aics <- sapply(models, "[[", "aic")
# show the winning model
models[which.min(aics)]
                            </code></pre>

                            <pre class="top-4"><code class="r">
$y2r
        LH         r1         r2        st1        aic 
 229.26699   18.31627    4.07539    0.01006 -452.53398 
                            </code></pre>
                        
                        <p>Yup, their result agrees with our analysis. Using the extensive toolset for diversification rates in R, we could now rather easily check if these results hold up in newer methods such as TreePar, etc.</p>
                    </section><!-- /usage -->

                    <section id="meta-analysis">
                        <h3 id="meta-analysis">Meta-Analysis</h3>

                        <p>Of course one of the more interesting challenges of having an automated interface is the ability to perform meta-analyses across the set of available phylogenies in treebase. As a simple proof-of-principle, let's check all the phylogenies in treebase to see if they fit a birth-death model or yule model better.</p>

                        <p>We'll create two simple functions to help with this analysis. While these can be provided by the treebase package, I've included them here to illustrate that the real flexibility comes from being able to create custom functions(These are primarily illustrative; I hope users and developers will create their own. In a proper analysis we would want a few additional checks.)</p>

                        
                            <pre><code class="r">
timetree <- function(tree){
    check.na <- try(sum(is.na(tree$edge.length))>0)
    if(is(check.na, "try-error") | check.na)
      NULL
    else
    try( chronoMPL(multi2di(tree)) )
}
drop_errors <- function(tr){
  tt <- tr[!sapply(tr, is.null)]
  tt <- tt[!sapply(tt, function(x) is(x, "try-error"))]
  print(paste("dropped", length(tr)-length(tt), "trees"))
  tt
}
require(laser)
pick_branching_model <- function(tree){
  m1 <- try(pureBirth(branching.times(tree)))
  m2 <- try(bd(branching.times(tree)))
  as.logical(try(m2$aic < m1$aic))
}

                            </code></pre>

                        <p>Return only treebase trees that have branch lengths. This has to download every tree in treebase, so this will take a while. Good thing we don't have to do that by hand.</p>
                        
                            <pre><code class="r">
all <- search_treebase("Consensus", "type.tree", branch_lengths=TRUE)
tt <- drop_errors(sapply(all, timetree))
is_yule <- sapply(tt, pick_branching_model)
table(is_yule)
                            </code></pre>
                        
                        <p><em>Note: The output is not shown, but do run on your own!</em></p>
                    </section><!-- /analysis -->

                    <section id="citing">
                        <h3 id="citing">Citing</h3>
                        <p>To cite <code class="r">treebase</code> in publications use:</p>

                        <blockquote>
                            <p>Carl Boettiger and Duncan Temple Lang (2011). treebase: An R package for discovery, access and manipulation of online phylogenies. R package version 0.0-7.1. 
                            
                            <a href="https://github.com/ropensci/treebase">https://github.com/ropensci/treebase</a></p>
                        </blockquote>
                    </section><!-- /citing -->

                    <section>
                        <h3 id="license-and-bugs">License and bugs</h3>
                        <ul>
                            <li>License: <a href="http://creativecommons.org/choose/zero/">CC0</a></li>
                            <li>Report bugs at <a href="https://github.com/ropensci/treebase/issues?state=open">our Github repo for treebase</a></li>
                        </ul>
                    </section><!-- /licence and bugs -->

                </div><!-- /main text container -->
            </div>
        </div>
    </article>

<!-- beggins diquss section -->
    <section class="disqus">
        <div class="container">
            <div class="row center">
                <div class="col-9">
                <!-- here goes the embedding code -->
                    <div id="disqus_thread"></div>
                    <script>
                        /**
                         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                         */
                        /*
                        var disqus_config = function () {
                            this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
                            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                        };
                        */
                        (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
                            var d = document, s = d.createElement('script');
                            
                            s.src = '//EXAMPLE.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!
                            
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>
            </div>
        </div>
    </section>

     <!-- begin footer -->
    <div id="footer">
        <div class="container">
            <div class="row start">
                <div class="col-1 col-1-3 top-8">
                    <img src="img/icon_short_white.svg" />
                </div>

                <div class="col-9 col-offset-2 top-10 bottom-8">
                    <div class="row between">
                        <div class="col-2 col-1-3">
                            <a href="http://github.com/ropensci" target="_blank"><div class="icon icon-github"></div></a>
                            <a href="http://twitter.com/ropensci" target="_blank"><div class="icon icon-twitter"></div></a>
                            <a href="http://vimeo.com/ropensci" target="_blank"><div class="icon icon-vimeo"></div></a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Info</h5>
                                <li><a href="careers.html">Careers</a></li>
                                <li><a href="http://discuss.ropensci.org/" target="_blank">Discuss</a></li>
                                <li><a href="community.html#events">Events</a></li>
                                <li><a href="related.html">Related</a></li>
                            </ul>
                        </div>

                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Work</h5>
                                <li><a href="packages.html">Packages</a></li>
                                <li><a href="blog.html">Blog</a></li>
                                <li><a href="tutorials.html">Tutorials</a></li>
                                <li><a href="use_cases.html">Use Cases</a></li>
                                <li><a href="resources.html">Resources</a></li>
                            </ul>
                        </div>
                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">About</h5>
                                <li><a href="about.html">Team</a></li>
                                <li><a href="community.html">Community</a></li>
                                <li><a href="donate.html">Donate</a></li>
                                <li><a href="careers.html">Careers</a></li>
                                <li><a href="coc.html">Code of Conduct</a></li>
                            </ul>
                        </div>
                        <div class="col-4 top-8 bottom-8">
                            <h5 class="bottom-2">Sponsorship</h5>
                            <p>rOpenSci is a fiscally sponsored project by <a href="http://numfocus.org" target="_blank">NumFocus</a></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 top-8 bottom-9 divider">
                    <p class="top-9">Except where otherwise noted, content on this site is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY license</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
<!-- / end footer -->


    <!-- loads jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <!-- loads sidebar scripts -->
    <script type="text/javascript" src="js/jquery.waypoints.js"></script>
    <script type="text/javascript" src="js/sticky.min.js"></script>
    <script type="text/javascript" src="js/sidebarinit.js"></script>

    <!-- loads scripts for highlight JS -->
    <script type="text/javascript" src="js/highlight.pack.js"></script>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
    </script>



</body>
</html>